<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Home - FastForum</title>
    <link href="/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/sb-admin-2.min.css" rel="stylesheet">
</head>

<body id="page-top">

    <div id="wrapper">
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">

                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <h1 class="h3 mb-0 text-gray-800 ml-3 mr-3">FastForum</h1>

                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control bg-light border-0 small"
                                placeholder="Search for posts..." aria-label="Search" aria-describedby="basic-addon2">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="btnSearch">
                                    <i class="fas fa-search fa-sm"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="btnLogout">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Logout</span>
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                            </a>
                        </li>
                    </ul>

                </nav>
                <div class="container-fluid">

                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Create New Post</h6>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" id="newTitle" class="form-control" placeholder="Title">
                                <textarea 
                                    id="newContent" 
                                    class="form-control"
                                    rows="5"
                                    placeholder="What's on your mind?"></textarea>
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button" id="btnCreate">Post</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="post-container">
                        <div class="text-center">Loading feed...</div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/login_page";

        // === 1. åŠ è½½å¸–å­ (æ”¯æŒæœç´¢) ===
        // é»˜è®¤ searchKeyword æ˜¯ç©ºå­—ç¬¦ä¸²
        async function loadPosts(searchKeyword = "") {
            try {
                // æ„å»º URLï¼šå¦‚æœæœ‰æœç´¢è¯ï¼Œå°±æ‹¼ä¸Šå»
                let url = "/posts/";
                if (searchKeyword) {
                    // ?search=xxx æ˜¯åç«¯å®šä¹‰çš„æŸ¥è¯¢å‚æ•°
                    url += `?search=${encodeURIComponent(searchKeyword)}`;
                }

                const response = await fetch(url, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (response.ok) {
                    const dataList = await response.json();
                    renderPosts(dataList);
                } else {
                    console.error("Failed to load posts.");
                }
            } catch (err) {
                console.error("Network error:", err);
            }
        }

        // === 2. æ¸²æŸ“é¡µé¢ (ä¿®æ”¹ç‰ˆ) ===
        function renderPosts(dataList) {
            const container = document.getElementById("post-container");
            container.innerHTML = "";

            if (dataList.length === 0) {
                container.innerHTML = "<p class='text-center text-gray-500'>No posts found.</p>";
                return;
            }

            dataList.forEach(item => {
                const post = item.Post; // ä½ çš„å¸–å­è¯¦æƒ…
                const votes = item.votes;

                // å¤„ç†ä½œè€…æ˜¾ç¤º
                const authorName = post.owner && post.owner.email ? post.owner.email.split('@')[0] : `User ${post.owner_id}`;

                // ----------------------------------------------------
                // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ç¬¬ä¸€æ­¥ï¼šè¿™é‡Œæ˜¯æ–°å¢çš„å¾ªç¯é€»è¾‘ï¼Œç”¨æ¥ç”Ÿæˆè¯„è®º HTML ğŸ‘‡ğŸ‘‡ğŸ‘‡
                // ----------------------------------------------------
                let commentsHTML = '';

                // æ£€æŸ¥æœ‰æ²¡æœ‰ comments å­—æ®µï¼Œå¹¶ä¸”æ•°ç»„é•¿åº¦å¤§äº 0
                if (post.comments && post.comments.length > 0) {
                    // åŠ ä¸€ä¸ªæ ‡é¢˜
                    commentsHTML += `<h6 class="small font-weight-bold text-secondary mt-3 mb-2 ml-1">Comments (${post.comments.length})</h6>`;

                    post.comments.forEach(comment => {
                        // æ ¼å¼åŒ–æ—¶é—´ (å¯é€‰)
                        const commentTime = new Date(comment.created_at).toLocaleString();

                        // æ‹¼æ¥æ¯ä¸€æ¡è¯„è®ºçš„æ ·å¼ (ç”¨ç°è‰²èƒŒæ™¯åŒºåˆ†)
                        commentsHTML += `
                            <div class="p-2 mb-2 bg-gray-200 rounded border-left-primary" style="background-color: #f8f9fc; border-left: 4px solid #4e73df;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="small font-weight-bold text-primary">${comment.owner.email.split('@')[0]}</span>
                                    <span class="small text-gray-500" style="font-size: 0.75rem;">${commentTime}</span>
                                </div>
                                <div class="text-dark small mt-1">
                                    ${comment.content}
                                </div>
                            </div>
                        `;
                    });

                    // æŠŠæ‰€æœ‰è¯„è®ºåŒ…åœ¨ä¸€ä¸ªå¸¦æ»šåŠ¨æ¡çš„ç›’å­é‡Œ (é˜²æ­¢è¯„è®ºå¤ªå¤šæ‹‰å¤ªé•¿)
                    commentsHTML = `
                        <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
                            ${commentsHTML}
                        </div>
                    `;
                } else {
                    // å¦‚æœæ²¡æœ‰è¯„è®ºï¼Œç•™ç©ºæˆ–è€…æ˜¾ç¤ºæç¤º
                    commentsHTML = `<div class="mb-3 text-center small text-gray-500 py-2">No comments yet.</div>`;
                }
                // ----------------------------------------------------


                const html = `
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">${post.title}</h6>
                            <span class="small text-gray-500">Author: ${authorName}</span>
                        </div>
                        <div class="card-body">
                            <p style="white-space: pre-wrap;">${post.content}</p>
                            
                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="getAiSummary(${post.id}, this)">
                                    <i class="fas fa-magic"></i> AI Summary
                                </button>
                                <div id="summary-box-${post.id}" class="alert alert-success mt-2 small" style="display:none;"></div>
                            </div>

                            <hr>
                            <div class="d-flex align-items-center mb-3"> <button onclick="votePost(${post.id})" class="btn btn-success btn-circle btn-sm mr-2">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <span class="font-weight-bold">${votes}</span>
                                <span class="ml-auto small text-gray-500">${new Date(post.created_at).toLocaleString()}</span>
                            </div>

                            ${commentsHTML}
                            
                            <div class="input-group">
                                <input type="text" id="comment-input-${post.id}" class="form-control form-control-sm" placeholder="Write a comment...">
                                <div class="input-group-append">
                                    <button class="btn btn-primary btn-sm" type="button" onclick="submitComment(${post.id})">
                                        <i class="fas fa-paper-plane"></i> Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // === 3. ç›‘å¬æœç´¢æŒ‰é’® ===
        document.getElementById("btnSearch").addEventListener("click", function () {
            // æ‹¿åˆ°è¾“å…¥æ¡†é‡Œçš„å­—
            const keyword = document.getElementById("searchInput").value;
            // é‡æ–°åŠ è½½å¸–å­ï¼ˆå¸¦å‚æ•°ï¼‰
            loadPosts(keyword);
        });

        // (å¯é€‰) ç›‘å¬æœç´¢æ¡†çš„å›è½¦é”®
        document.getElementById("searchInput").addEventListener("keypress", function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢è¡¨å•è‡ªåŠ¨åˆ·æ–°
                const keyword = document.getElementById("searchInput").value;
                loadPosts(keyword);
            }
        });

        // === 4. å‘å¸–åŠŸèƒ½ ===
        document.getElementById("btnCreate").addEventListener("click", async () => {
            const title = document.getElementById("newTitle").value;
            const content = document.getElementById("newContent").value;
            if (!title || !content) { alert("Title and content cannot be empty."); return; }

            const response = await fetch("/posts/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ title, content, published: true })
            });

            if (response.ok) {
                document.getElementById("newTitle").value = "";
                document.getElementById("newContent").value = "";
                loadPosts();
            } else {
                alert("Failed to create post.");
            }
        });

        // === 5. ç‚¹èµåŠŸèƒ½ ===
        async function votePost(postId) {
            try {
                const response = await fetch("/vote/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ post_id: postId, dir: 1 })
                });

                if (response.ok) {
                    loadPosts();
                } else if (response.status === 409) {
                    // å¦‚æœå·²ç»ç‚¹èµï¼Œåˆ™å–æ¶ˆ (dir=0)
                    await fetch("/vote/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                        body: JSON.stringify({ post_id: postId, dir: 0 })
                    });
                    loadPosts();
                }
            } catch (err) { console.error(err); }
        }

        // === 6. é€€å‡ºç™»å½• ===
        document.getElementById("btnLogout").addEventListener("click", () => {
            localStorage.removeItem("token");
            window.location.href = "/login_page";
        });

        // === 7. æäº¤è¯„è®º ===
        // å‘é€è¯„è®ºçš„å‡½æ•°
        async function submitComment(postId) {
            // 1. è·å–å¯¹åº”å¸–å­çš„è¾“å…¥æ¡†å†…å®¹
            const inputId = `comment-input-${postId}`;
            const inputElement = document.getElementById(inputId);
            const content = inputElement.value.trim(); // .trim() å»æ‰å‰åçš„ç©ºæ ¼

            // 2. ç®€å•æ£€æŸ¥
            if (!content) {
                alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            // 3. è·å– Token
            const token = localStorage.getItem("token"); // å‡è®¾ä½ å­˜ Token çš„ key å« 'token'
            if (!token) {
                alert("è¯·å…ˆç™»å½•å†è¯„è®ºï¼");
                window.location.href = "login.html"; // å¦‚æœæ²¡ç™»å½•ï¼Œè·³å»ç™»å½•é¡µ
                return;
            }

            try {
                // 4. å‘é€è¯·æ±‚ç»™åç«¯
                // è¿™é‡Œçš„ URL è¦æ”¹æˆä½ çœŸå®çš„åç«¯åœ°å€ï¼Œæ³¨æ„æ˜¯ /comments/ è¿˜æ˜¯ /comments/{post_id}ï¼Œå–å†³äºä½ çš„ Router å†™æ³•
                // å‡è®¾ä½ ç”¨çš„æ˜¯ schemas é‡Œçš„ post_id æ”¾åœ¨ body é‡Œï¼š
                const response = await fetch("/comments/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        content: content
                    })
                });

                if (response.ok) {
                    // æˆåŠŸï¼
                    alert("è¯„è®ºæˆåŠŸï¼ğŸ‰");
                    inputElement.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä½“éªŒæ›´å¥½
                } else {
                    // å¤±è´¥
                    const data = await response.json();
                    alert("å‘é€å¤±è´¥: " + (data.detail || "æœªçŸ¥é”™è¯¯"));
                }

            } catch (error) {
                console.error("Error:", error);
                alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨");
            }
        }

        // === 8. AI æ‘˜è¦åŠŸèƒ½ ===
        async function getAiSummary(postId, btnElement) {
            // 1. æ‰¾åˆ°å¯¹åº”çš„ç»“æœæ˜¾ç¤ºæ¡†
            const summaryBox = document.getElementById(`summary-box-${postId}`);

            // 2. æ”¹å˜ UI çŠ¶æ€ï¼ˆæ˜¾ç¤ºåŠ è½½ä¸­ï¼‰
            btnElement.disabled = true; // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            const originalBtnText = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...'; // æŒ‰é’®è½¬åœˆåœˆ

            summaryBox.style.display = 'block'; // æ˜¾ç¤ºç›’å­
            summaryBox.className = "alert alert-secondary mt-2 small"; // ç°è‰²èƒŒæ™¯
            summaryBox.innerText = "Gemini is reading this post...";

            try {
                const token = localStorage.getItem("token");

                // 3. å‘é€è¯·æ±‚ (æ³¨æ„ URL è¦å’Œä½ åç«¯ä¸€è‡´)
                const response = await fetch(`/ai/summarize/${postId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token // è™½ç„¶ AI å¯èƒ½ä¸éœ€è¦é‰´æƒï¼Œä½†å¸¦ä¸Šä¹Ÿæ²¡åå¤„
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    // 4. æ˜¾ç¤ºæˆåŠŸç»“æœ
                    // åç«¯è¿”å›çš„ key å¯èƒ½æ˜¯ summary ä¹Ÿå¯èƒ½æ˜¯ ai_summaryï¼Œè¿™é‡Œåšäº†å…¼å®¹
                    const summaryText = data.summary || data.ai_summary;

                    summaryBox.className = "alert alert-success mt-2 small"; // ç»¿è‰²èƒŒæ™¯
                    // åŠ ä¸ªæœºå™¨äººå›¾æ ‡ï¼Œçœ‹èµ·æ¥æ›´é«˜çº§
                    summaryBox.innerHTML = `<strong>ğŸ¤– AI Summary:</strong><br>${summaryText}`;

                    // æ¢å¤æŒ‰é’®ï¼ˆå˜æˆå®ŒæˆçŠ¶æ€ï¼‰
                    btnElement.innerHTML = '<i class="fas fa-check"></i> Done';
                } else {
                    // å¤„ç†åç«¯é”™è¯¯ (æ¯”å¦‚ 404 æˆ– 500)
                    summaryBox.className = "alert alert-danger mt-2 small"; // çº¢è‰²èƒŒæ™¯
                    summaryBox.innerText = "Failed to generate summary.";
                    btnElement.innerHTML = originalBtnText; // æ¢å¤æŒ‰é’®è®©ç”¨æˆ·é‡è¯•
                    btnElement.disabled = false;
                }

            } catch (error) {
                console.error("AI Error:", error);
                summaryBox.className = "alert alert-danger mt-2 small";
                summaryBox.innerText = "Network Error. Is backend running?";
                btnElement.innerHTML = originalBtnText;
                btnElement.disabled = false;
            }
        }


        // é¡µé¢åˆå§‹åŒ–ï¼šåŠ è½½æ‰€æœ‰å¸–å­
        loadPosts();
    </script>

</body>

</html>