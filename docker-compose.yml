version: '3.8'

services:
  # --- åç«¯ ---
  api:
    build: ./backend         # å» backend æ–‡ä»¶å¤¹æ‰¾ Dockerfile
    # ğŸ‘‡ 1. åŠ è¿™è¡Œï¼šå¦‚æœå´©æºƒäº†ï¼Œè‡ªåŠ¨é‡å¯ (è®©å®ƒè‡ªå·±çˆ¬èµ·æ¥å†è¯•)
    restart: always
    # ğŸ‘‡ 2. ä¿®æ”¹ commandï¼šå…ˆç¡ 10 ç§’ï¼Œå†å¹²æ´»
    command: bash -c "sleep 10 && alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app       # ä»£ç çƒ­é‡è½½
    env_file:
      - ./backend/.env       # è¯»å–åç«¯çš„ .env
    depends_on:
      - db
    environment:
      - DATABASE_HOSTNAME=db
      - DATABASE_PORT=5432
      - DATABASE_PASSWORD=SengFong_1203
      - DATABASE_NAME=fastapi
      - DATABASE_USERNAME=postgres

  # --- æ•°æ®åº“ ---
  db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: SengFong_1203
      POSTGRES_DB: fastapi
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # --- å‰ç«¯ ---
  frontend:
    build: ./frontend        # å» frontend æ–‡ä»¶å¤¹æ‰¾ Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules    # é¿å‘ï¼šä½¿ç”¨å®¹å™¨å†…çš„ä¾èµ–
    environment:
      - CHOKIDAR_USEPOLLING=true # Windows å¿…é¡»åŠ 

volumes:
  postgres_data: